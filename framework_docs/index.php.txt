<?php
//common.php에서 $_SERVER["DOCUMENT_ROOT"]."/_library/config.php" 를 require
require $_SERVER["DOCUMENT_ROOT"]."/_include/common.php";

//전역으로 쓰이는 php함수를 저장해놓은 파일
require CFG_LIB_PATH."/function.php";

//각 상황별, 언어별 alert문구를 정리해놓은 파일
require CFG_LIB_PATH."/translator.php";

if($_SERVER["HTTPS"] != "on" && SITE_SSL == "https")
{
	header("Location: ".DEFAULT_DOMAIN.$_SERVER["REQUEST_URI"]);
	exit;
}

//DB에 접근, 관리하기위한 모든함수를 정리해놓은 파일, DB접근시 해당파일 내에있는 함수 외에 사용하지않음.
require CFG_MODEL_PATH_ABS."/class.db_query.php";
$cls_db = new db_connect();

//사이트에 접속한 로그를 관리하는 모델
require CFG_MODEL_PATH_ABS."/class.connect.php";
$cls_connect = new connect();

//사이트 전역에서 사용할 배열을 관리하는 모델, 배열은 pwmngr 관리자 페이지에서 등록,수정,삭제 가능
require CFG_MODEL_PATH_ABS."/class.arrays.php";
$cls_arrays = new arrays();

//사이트의 정보를 관리하는 모델
require CFG_MODEL_PATH_ABS."/class.site.php";
$cls_site = new site();

//사이트의 SEO관련된 설정을 관리하는 모델
require CFG_MODEL_PATH_ABS."/class.seo.php";
$cls_seo = new seo();

//DB에 저장된 사이트 정보를 배열로 담는다.
$site = $cls_site->get_view_site(1);

//관리자모드에서 on/off가능한 사이트 접근방지 관련소스코드
if($site["allow_flag"] == "y")
{
	$allow_ips = explode("\r\n", $site["allow_ip"]);

	if(in_array($_SERVER["REMOTE_ADDR"], $allow_ips) === false)
	{
		exit;
	}
}

//DB에 저장된 모든 배열관련 정보를 $array_value에 담는다.
$array_value = $cls_arrays->get_list_arraysValue();
if(count((array)$array_value["idx"]) > 0)
{
	// 관리자 > 운영관리 > 배열관리에 등록한 데이터를 배열로 만들어서 저장
	for($i=0; $i < count($array_value["idx"]); $i++)
	{
		${$array_value["category_code"][$i]}[$array_value["key"][$i]] = $array_value["value"][$i];
	}

	// 연락처 국번 배열 - 펙스와 인터넷전화 배열을 하나로 묶는다.
	$telephone = $faxphone + $internetphone;

	// 휴대폰 + 연락처 국번 배열 - 휴대폰과 일반전화 국번 매열을 하나로 묶는다.
	$fullphone = $handphone + $telephone;
}

// 사이트 접속시 접속 카운트 추가
add_connect();

/**
 * 폴더, 페이지, 게시판ID 설정 - s
 * 사이트는 기본적으로 도메인/폴더/페이지/게시판ID 순서의 구조를 가진다.
 */
$public_url = empty($_REQUEST["public_url"]) ? "" : str_replace("www", "", $_REQUEST["public_url"]);
list($folder, $page, $board_id) = explode("/", substr($public_url, 1));

$list_max = 20;
$paging_max = 10;
$paging = empty($_REQUEST["paging"]) ? 1 : $_REQUEST["paging"]; // 페이징 번호

// 폴더설정
if(empty($folder))
{
	$folder_path = "";
}
else
{
	$folder_path = "/".$folder;
}

// 페이지 경로 설정
if(empty($page))
{
	$source_path = "index";
}
else
{
	$source_path = "";
	$exp = explode("_", $page);
	for($i=0; $i<count($exp); $i++)
	{
		if($source_path != "")
		{
			$source_path .= "/".$exp[$i];
		}
		else
		{
			$source_path = $exp[$i];
		}
	}
}

//중간경로(다국어 사이트 등)
//다국어 사이트일 경우 구분용도, 영문사이트일경우 "eng"
$_SESSION["cfg_site_language"] = "kr";

//영문사이트인경우 _view/eng 폴더내에 _view폴더내의 구조를 복사해서 같은 구조를가진다.
//eng폴더 내에 저장된 htm파일은 영문으로된 내용으로 한국사이트와 다른 파일을 바라보게한다.
//$middle_path를 _controller 내의 파일들의 경로사이에 넣어 어떤파일을 열지 결정한다.
$middle_path = "";
if(empty($_SESSION["cfg_site_language"]) || $_SESSION["cfg_site_language"] == "kr")
{
	$middle_path = "";
}
else
{
	$middle_path = "/".$_SESSION["cfg_site_language"];
}

//모바일 기기에서 접근했는지 체크하는 변수. 모바일일경우 값을 y로 지정.
$mobile_ck = "n";
$mobile_path = "";
$mobileKeyWords = array ('iPhone', 'iPod', 'iPad', 'BlackBerry', 'Android', 'Windows CE', 'Windows CE;', 'LG', 'MOT', 'SAMSUNG', 'SonyEricsson', 'Mobile', 'Symbian', 'Opera Mobi', 'Opera Mini', 'IEmobile');
for($i=0 ; $i<count((array)$mobileKeyWords) ; $i++)
{
	if(strpos($_SERVER['HTTP_USER_AGENT'], $mobileKeyWords[$i]) > -1)
	{
		$mobile_ck = "y";
		$mobile_path = "/";
	}
}

//레이어용이나 ajax, 프로세스 관련된 역할을하는 페이지는 헤더등 다른 페이지로부터 독립하기위해 배열에 담아 구분한다.
//새로생성된 프로세스에 관련된 페이지는 해당 배열에 수동으로 추가해준다.
//추가된 페이지는 헤더,푸터없이 해당페이지만 출력된다.
$layer_popup_array = array(
	"password"
);
$process_array = array(
	"proc"
);

if(!in_array($page, $process_array))
{
	//look around log 설정
	require CFG_BASE_PATH."/_include/look_around_log.php";
}

if(in_array($page, $process_array) || in_array($page, $layer_popup_array))
{
	// ajax 관련된 페이지는 헤더, 푸터를 출력하지 않고 내용만 출력한다.
	require CFG_CONTROLLER_PATH_ABS.$folder_path."/".$source_path.".php";
}
else
{
	//헤더에 추가할 ogimage 파일
	//관리자모드에서 등록해둔 ogimage파일이있으면 해당이미지를 사용한다.
	$default_ogImage = "";
	if (empty($site["og_image"]) === false) {
		$default_ogImageTmp = json_decode($site["og_image"], true);

		if (file_exists(CFG_PUBLIC_PATH_ABS."/uploadFiles/cfg/".$default_ogImageTmp["saved"]) === true) {
			$default_ogImage = DEFAULT_DOMAIN.CFG_PUBLIC_PATH."/uploadFiles/cfg/".$default_ogImageTmp["saved"];
		}
	}
	// seo 설정 검색
	if (!empty($board_id)) {
		if(!class_exists("board")) {
			require CFG_MODEL_PATH_ABS."/class.board.php";
		}
		$cls_board = new board();

		$site_name = $_SESSION["cfg_site_language"] == "kr" ? " [".$site["site_name_kr"]."]" : " [".$site["site_name_en"]."]";
		$board = $cls_board->get_view_boardInfo_search(array("s_boardId"=>$board_id), "`board_name`");
		$title = $board["board_name"];
		$url = DEFAULT_DOMAIN.$_SERVER["REQUEST_URI"];
		$canonical = $url;
		$idx = empty($_REQUEST["idx"]) ? null : $_REQUEST["idx"];
		switch ($page) {
			case "view":
				if (!empty($idx)) {
					$row = $cls_board->get_view_boardData($_REQUEST["idx"], "`subject`");
					if (!empty($row["subject"])) {
						$title .= " > ".$row["subject"];
					}
					$canonical = DEFAULT_DOMAIN."/".$folder."/list/".$board_id;
				}
			break;
			case "form":
				$title .= !empty($idx) ? " > 게시물 수정" : " > 게시물 작성";
			break;
		}
		$seoMeta = array(
			"title"=>$title.$site_name,
			"description"=>$title.$site_name,
			"canonical"=>$canonical,
			"og_image"=>$default_ogImage,
			"og_url"=>$url
		);
	} else {
		$s_pageUrl = $folder_path."/".$source_path;

		// 메인 페이지
		if (in_array($s_pageUrl, array("//", "/index")) === true) {
			$s_pageUrl = "/";
		}

		$seoMeta = array(
			"title"=>$site["meta_subject"],
			"description"=>$site["meta_description"],
			"canonical"=>"",
			"og_image"=>$default_ogImage,
			"og_url"=>$site["og_url"]
		);
		$seo = $cls_seo->get_view_seo_search(array(
			"s_language"=>$_SESSION["cfg_site_language"],
			"s_pageUrl"=>$s_pageUrl
		), "`idx`, `meta_subject`, `meta_description`, `canonical`, `og_image`, `og_url`");
		if (count((array)$seo["idx"]) > 0) {
			$seo_ogImage = "";
			if (empty($seo["og_image"]) === false) {
				$seo_ogImageTmp = json_decode($seo["og_image"], true);
				if (file_exists(CFG_PUBLIC_PATH_ABS."/uploadFiles/seo/".$seo["idx"]."/".$seo_ogImageTmp["saved"]) === true) {
					$seo_ogImage = DEFAULT_DOMAIN.CFG_PUBLIC_PATH."/uploadFiles/seo/".$seo["idx"]."/".$seo_ogImageTmp["saved"];
				}
			}

			$seoMeta = array(
				"title"=>$seo["meta_subject"],
				"description"=>$seo["meta_description"],
				"canonical"=>$seo["canonical"],
				"og_image"=>$seo_ogImage,
				"og_url"=>$seo["og_url"]
			);
		}
	}
	require CFG_PUBLIC_PATH_ABS.$mobile_path."/header.php";
	require CFG_LIB_PATH."/api.function.php";
	require CFG_CONTROLLER_PATH_ABS.$folder_path."/".$source_path.".php";
	require CFG_PUBLIC_PATH_ABS.$mobile_path."/footer.php";
}
?>
